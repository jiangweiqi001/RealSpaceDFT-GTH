# JaxDFT 实空间 DFT 构型空间采样

## 1. 项目概述

本项目用于在实空间网格上执行基于 JAX 的密度泛函计算，并对随机原子簇进行构型空间采样，输出包含能量与力的结构化数据集。核心目标是以可复现、可扩展的方式生成训练或验证所需的原子构型数据，同时提供 H2 分子基准对比脚本用于快速验证数值行为。

**技术栈与依赖环境**

| 类别 | 说明 |
| --- | --- |
| 语言 | Python 3 |
| 计算框架 | JAX、JAXLIB |
| 数值与I/O | NumPy、SciPy、PyYAML、HDF5(h5py) |
| 可选验证 | PySCF（能量/力对比）、Matplotlib（曲线可视化） |

**主要特点与优势**

- 基于实空间网格的 DFT 实现，避免显式基组依赖
- 利用 JAX 自动微分直接获得原子力
- 赝势采用 GTH-LDA 格式，内置数据文件可直接使用
- 采样流程标准化输出 HDF5，便于下游训练或分析
- 支持 H2 曲线验证与对比（可选 PySCF）

## 2. 功能模块说明

### 2.1 模块列表与功能

| 模块 | 位置 | 作用 | 输入 | 输出 |
| --- | --- | --- | --- | --- |
| 采样脚本 | JaxDFT/scripts/run_sampling.py | 批量生成随机簇并计算能量/力 | 配置文件、元素集合、网格参数 | dataset.h5 |
| H2 验证脚本 | JaxDFT/scripts/verify_h2.py | H2 伸缩扫描与对比 | 距离范围、网格参数 | 表格输出、曲线图 |
| 网格与哈密顿量 | JaxDFT/src/hamiltonian.py | 实空间网格、赝势与投影子构建 | 原子坐标、伪势 | Grid3D、局域/非局域势 |
| 交换相关 | JaxDFT/src/functional.py | LDA 交换相关与势能 | 电子密度 | ε_xc 与 v_xc |
| 求解器 | JaxDFT/src/solver.py | SCF、能量与力计算 | Grid、坐标、伪势、SCF参数 | 总能量与力 |
| 输入输出 | JaxDFT/src/io.py | 赝势解析、配置读取、HDF5 写入 | YAML、伪势文本 | 结构化数据对象 |
| 结构生成 | JaxDFT/src/structure.py | 随机簇生成与最小距离约束 | 元素集合、盒子大小 | 原子坐标与元素列表 |
| 配置 | JaxDFT/config/default.yaml | 采样与 SCF 参数 | 无 | 被脚本读取 |
| 赝势数据 | JaxDFT/data/gth_potentials | GTH-LDA 伪势库 | 元素符号 | 伪势参数 |

### 2.2 模块交互关系

1. `run_sampling.py` 读取配置并生成随机簇  
2. `structure.py` 返回原子坐标与元素  
3. `io.py` 加载对应 GTH 伪势参数  
4. `hamiltonian.py` 构建网格与势能项  
5. `solver.py` 进行 SCF 并输出能量与力  
6. `io.py` 将数据写入 `dataset.h5`  

### 2.3 主要输入输出说明

**采样脚本输入**

- 配置文件：`JaxDFT/config/default.yaml`
- 关键参数：网格间距、盒子大小、采样数、元素集合、SCF 参数

**采样脚本输出**

- 文件：`dataset.h5`
- 数据集结构：

| 数据集 | 含义 | 典型形状 |
| --- | --- | --- |
| R | 原子坐标 | [N, n_atoms, 3] |
| Z | 原子序数 | [N, n_atoms] |
| E | 总能量 (Ha) | [N] |
| F | 原子力 (Ha/Bohr) | [N, n_atoms, 3] |

**H2 验证脚本输出**

- 控制台表格：距离、能量、力及与 PySCF 的差值  
- 可选图像：`JaxDFT/scripts/h2_verification.png`

## 3. 实现细节

### 3.1 关键技术实现方案

- **实空间网格**：`create_grid` 依据盒子大小与间距生成 3D 均匀网格
- **赝势与投影子**：GTH 赝势解析为局域势与非局域投影子
- **SCF 循环**：密度初始化、泊松方程求解、LDA 交换相关、密度混合迭代
- **能量与力**：能量函数通过 `jax.value_and_grad` 自动求导得到力

### 3.2 核心算法与逻辑

```text
生成随机簇
  -> 构建网格与伪势
  -> 初始化密度
  -> SCF 自洽求解 (哈密顿量 + LDA + 泊松)
  -> 计算总能量
  -> 自动微分获取原子力
  -> 写入 HDF5 数据集
```

### 3.3 代码结构与设计模式

- 数据结构：`Grid3D` 与伪势相关 dataclass 作为统一数据载体
- 计算模块解耦：网格与势能、交换相关、求解器、I/O 独立维护
- 入口脚本驱动：采样与验证均在脚本中统一组织

### 3.4 性能优化措施

- `jax.jit` 对关键数值函数进行即时编译
- 使用向量化操作减少 Python 循环开销
- 泊松方程通过 FFT 实现高效求解
- 对数值异常使用 `nan_to_num` 进行稳定化处理
- 投影子预构建减少 SCF 迭代内重复计算
